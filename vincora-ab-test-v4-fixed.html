<script>
// VERSION: 2024-12-23-v4-FIXED
(function() {
    'use strict';
    var cfg = {
        originalUrl: '/test-page',
        testUrl: '/test-page-1',
        testTraffic: 50,
        conditions: [{ param: 'utm_source', contains: 'Vincora' }],
        cookieName: 'ab_var',
        cookieDays: 30,
        enableLogs: true
    };
    function log(msg, data) {
        if (!cfg.enableLogs) return;
        console.log('%c[A/B v4]%c ' + msg, 'color:#9C27B0;font-weight:bold', 'color:inherit', data||'');
    }
    function getCookie(name) {
        var m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
        return m ? decodeURIComponent(m[1]) : null;
    }
    function setCookie(name, value, days) {
        var d = new Date();
        d.setTime(d.getTime() + days * 864e5);
        document.cookie = name + '=' + value + '; expires=' + d.toUTCString() + '; path=/; SameSite=Lax';
    }
    function hash(str) {
        var h = 0;
        for (var i = 0; i < str.length; i++) {
            h = ((h << 5) - h) + str.charCodeAt(i);
            h &= h;
        }
        return Math.abs(h) % 100;
    }
    function getUserId() {
        var uid = getCookie('_ab_uid');
        if (!uid) {
            uid = Date.now().toString(36) + Math.random().toString(36).substr(2);
            setCookie('_ab_uid', uid, 365);
        }
        return uid;
    }
    function checkConditions(conditions) {
        if (!conditions || !conditions.length) return true;
        var params = new URLSearchParams(window.location.search);
        for (var i = 0; i < conditions.length; i++) {
            var c = conditions[i];
            var v = params.get(c.param);
            if (v && v.indexOf(c.contains) !== -1) return true;
        }
        return false;
    }
    function sendToMetrika(variant) {
        if (window.ym && window.Ya && window.Ya._metrika) {
            try {
                var counters = window.Ya._metrika.getCounters();
                if (counters && counters.length) {
                    ym(counters[0].id, 'params', { ab_variant: variant });
                    log('âœ“ ÐœÐµÑ‚Ñ€Ð¸ÐºÐ° OK (ID:' + counters[0].id + ')');
                    return true;
                }
            } catch(e) {}
        }
        return false;
    }
    function sendToRoistat(variant) {
        if (window.roistat && window.roistat.event) {
            try {
                roistat.event.send('ab_test', { variant: variant });
                log('âœ“ Roistat OK');
                return true;
            } catch(e) {}
        }
        return false;
    }
    function waitForAnalytics(variant) {
        var attempts = 0;
        var maxAttempts = 50;
        var interval = setInterval(function() {
            attempts++;
            var metrikaSent = sendToMetrika(variant);
            var roistatSent = sendToRoistat(variant);
            if (metrikaSent || roistatSent || attempts >= maxAttempts) {
                clearInterval(interval);
                if (attempts < maxAttempts) {
                    log('âœ“ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ (Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° ' + attempts + ')');
                }
            }
        }, 100);
    }
    log('â•â•â• v4 Ð—ÐÐŸÐ£Ð¡Ðš â•â•â•');
    var path = window.location.pathname;

    // Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð•: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¢ÐžÐ§ÐÐžÐ• ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ðµ, ÑÐ½Ð°Ñ‡Ð°Ð»Ð° Ð±Ð¾Ð»ÐµÐµ Ð´Ð»Ð¸Ð½Ð½Ñ‹Ð¹ URL!
    var isTest = path === cfg.testUrl;
    var isOrig = !isTest && path === cfg.originalUrl;

    log('ÐŸÑƒÑ‚ÑŒ: ' + path + ' | isOrig=' + isOrig + ' | isTest=' + isTest);

    if (!isOrig && !isTest) {
        log('Ð¡Ñ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ð½Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð²ÑƒÐµÑ‚');
        return;
    }
    if (!checkConditions(cfg.conditions)) {
        log('Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð½Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹');
        return;
    }
    log('âœ“ Ð£ÑÐ»Ð¾Ð²Ð¸Ñ ÐžÐš');
    var variant = getCookie(cfg.cookieName);
    if (!variant) {
        var bucket = hash(getUserId());
        variant = bucket < cfg.testTraffic ? 'test' : 'original';
        setCookie(cfg.cookieName, variant, cfg.cookieDays);
        log('ÐÐ¾Ð²Ñ‹Ð¹: ' + variant);
    } else {
        log('Ð’ÐµÑ€Ð½ÑƒÐ»ÑÑ: ' + variant);
    }
    if (variant === 'test' && isOrig) {
        log('ðŸ”„ Ð Ð•Ð”Ð˜Ð Ð•ÐšÐ¢ â†’ test');
        window.location.replace(cfg.testUrl + window.location.search);
    } else if (variant === 'original' && isTest) {
        log('ðŸ”„ Ð Ð•Ð”Ð˜Ð Ð•ÐšÐ¢ â†’ original');
        window.location.replace(cfg.originalUrl + window.location.search);
    } else {
        log('âœ“ ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð°');
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                waitForAnalytics(variant);
            });
        } else {
            waitForAnalytics(variant);
        }
    }
})();
</script>
